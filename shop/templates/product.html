{% load humanize %}
{% load static %}
<!doctype html>
<html lang="en">
<head>
    <link rel="stylesheet" href="{% static 'assets/css/product.css' %}">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ product.name }} - Kentainerss</title>
</head>

<body>

<header>
    {% include 'navbar.html' %}
</header>

<main class="product-wrapper">
    <div class="product-grid">

        <!-- LEFT PRODUCT IMAGE -->
        <div class="product-image-box">
            <img src="{{ product.image.url }}" alt="{{ product.name }}">
        </div>

        <!-- RIGHT SECTION -->
        <div class="product-details">

            <!-- TITLE -->
            <h1 class="p-title">{{ product.name }}</h1>

            <!-- PRICE -->
            <p class="p-from">
                <span style="font-family: Arial, sans-serif; font-size: small; font-weight: normal">From</span>
                <span>{{ product.price }}</span>
                <span style="font-family: Arial, sans-serif; font-size: small; font-weight: normal">KES</span>
            </p>

            <!-- DESCRIPTION -->
            <p class="p-desc">
                {{ product.description|truncatechars:170 }}
            </p>

            <!-- MORE INFO -->
            <p class="more-info" onclick="scrollToInfo()">More Information</p>

            <!-- SIZE DROPDOWN -->
            {% if options %}
                <select id="optionSelect" class="select-field">
                <option value="" disabled selected>Select Size (Litres / CMs)</option>
                    {% for opt in options %}
                        <option value="{{ opt.id }}"
                                data-price="{{ opt.price }}">
                            {{ opt.name }}
                        </option>

                    {% endfor %}
                </select>

            {% else %}
                <select class="select-field">
                    <option>Select Size (Litres / CMs)</option>
                </select>
            {% endif %}

            <!-- SHIPPING ZONE BUTTON -->
            <div class="select-field zone-button" id="zoneButton" onclick="openZoneModal()">
                Select Shipping Zone
                <span class="dropdown-icon">⌄</span>
            </div>

            <!-- ZONE LINK -->
            <p class="zone-link" onclick="openZoneModal()">Which Zone am I?</p>

            <!-- HIDDEN INPUT TO STORE ZONE -->
            <input type="hidden" id="zoneInput" name="zone" value="">

            <p class="p-size">
                <span id="productPrice">
                    {{ options.first.price }}
                </span> KES
            </p>

            <input type="hidden" name="option_id" id="optionInput">

            <!-- QUANTITY -->
            <div class="qty-box">
                <button id="minus">−</button>
                <span id="qty">1</span>
                <button id="plus">+</button>
            </div>

            <!-- ADD TO CART FORM -->
            <form id="addToCartForm" method="post" action="{% url 'add_to_cart' product.id %}">
                {% csrf_token %}
                <input type="hidden" id="qtyInput" name="quantity" value="1">

                <!-- MODIFIED BUTTON - INITIALLY DISABLED -->
                <button type="button" class="add-btn" id="addToCartBtn" disabled>Add to Basket</button>
            </form>

        </div>

    </div>
<!-- =========================
       INFORMATION SECTION
    ========================== -->
    <section class="product-info">

        <h2 id="product-information">Information</h2>

        <div class="info-meta">
    <p style="font-size: 13px">SKU: <strong>{{ product.sku }}</strong></p>
    <p>
        Category:
        <strong>
            {{ product.name }},
            <a href="{{ product.get_category_url }}" style="text-decoration: none; color: #0b1a4a">
                {{ product.get_category_display }}
            </a>
        </strong>
    </p>


</div>

        {{ product.description|safe }}

        <div class="info-links">
    {% if product.brochure %}
    <a href="{{ product.brochure.url }}" target="_blank">
        Download {{ product.name }} Brochure
    </a>
{% endif %}

</div>
{% if product.features.all %}
<h2>Features</h2>
<ul>
    {% for feature in product.features.all %}
        <li>{{ feature.text }}</li>
    {% endfor %}
</ul>
{% endif %}

{% if product.applications.all %}
<h2>Application</h2>
<ul>
    {% for app in product.applications.all %}
        <li>{{ app.text }}</li>
    {% endfor %}
</ul>
{% endif %}

    </section>

    <!-- =========================
       TRUST BADGES
    ========================== -->
    <section class="trust-section">
        <img src="{% static 'assets/image/support/durability.png' %}" alt="Durability">
    </section>

        <h2 style="font-weight: normal; font-family: Arial, sans-serif; font-size: 24px">
            More From {{ product.get_category_display }}
        </h2>

<div class="related-grid">
    {% for item in related_products %}
        <a href="{% url 'product_detail' item.slug %}" class="related-card">

            <img src="{{ item.image.url }}" alt="{{ item.name }}">

            <h3>{{ item.name }}</h3>

            {% if item.options.exists %}
                <p>From {{ item.options.first.price|intcomma }} KES</p>
            {% else %}
                <p>{{ item.price|intcomma }} KES</p>
            {% endif %}

        </a>
    {% empty %}
        <p>No other products in this category.</p>
    {% endfor %}
</div>

</main>

{% include "footer.html" %}

<!-- SHIPPING ZONE MODAL -->
<div id="zoneModal" class="zone-modal">
    <div class="zone-card">
        <span class="close-btn" onclick="closeZoneModal()">✕</span>
        <p class="close-text">Close</p>

        <h2 class="zone-title">Shipping Zones</h2>

        <div class="zones-grid">
            <div  onclick="selectZone('Zone 1')">
                <h4>Zone 1</h4>
                <p>0-50Km Nairobi, Karen, Ngong, Ongata Rongai, Kitengela, Athi River, Ruai, Juja, Ruiru, Kikuyu</p>
            </div>

            <div onclick="selectZone('Zone 2')">
                <h4>Zone 2</h4>
                <p>51-100Km Muranga, Kajiado, Machakos town, Naivasha</p>
            </div>

            <div onclick="selectZone('Zone 3')">
                <h4>Zone 3</h4>
                <p>101-150Km Magadi, Gilgil, Narok, Nyeri, Embu, Sultan Hamud</p>
            </div>

            <div onclick="selectZone('Zone 4')">
                <h4>Zone 4</h4>
                <p>151-250Km Nakuru, Nanyuki, Kitui, Mwingi, Molo, Nyahururu, Nanyuki, Solai, Londiani, Nyer Kisim, Lorule, Bomet, Nguni, Kitui, Kibwezi, Mitio Andei</p>
            </div>

            <div onclick="selectZone('Zone 5')">
                <h4>Zone 5</h4>
                <p>251-350Km Kericho, Kisii, Muhoroni, Isolo, Meru, Marigat, Kisumu, Eldoret, Kapasbet, Voi, Isolo Taveta, Maralal, Mau</p>
            </div>

            <div onclick="selectZone('Zone 6')">
                <h4>Zone 6</h4>
                <p>351-450Km Migori, Homabay, Butere, Kitale, Kindu bay, Kakamega, Tsavo, Bura, Garissa, Laisamis, Webuye, Bungoma, Maralal, Bondo, Siaya</p>
            </div>

            <div onclick="selectZone('Zone 7')">
                <h4>Zone 7</h4>
                <p>451-600Km Busia, Modogashi, Baragoi, Marsabit, Habaswein, Hagera, Liboi, Mombasa, Hola</p>
            </div>

            <div onclick="selectZone('Zone 8')">
                <h4>Zone 8</h4>
                <p>600-1100Km Loyiangalani, N. Horr, Buna, Wajir, Turukana, Lamu, Kakuma, Lokichogio, Moyale, Lodwa, Elwak, Takaba Mandera, Malindi</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const optionSelect = document.getElementById("optionSelect");
    const priceEl = document.getElementById("productPrice");
    const optionInput = document.getElementById("optionInput");

    // Hide price initially
    priceEl.style.display = "none";

    function updatePrice() {
        const selected = optionSelect.options[optionSelect.selectedIndex];
        const price = selected.dataset.price;

        if (price) {
            priceEl.style.display = "inline"; // show price
            priceEl.textContent = Number(price).toLocaleString();
            optionInput.value = selected.value;
        } else {
            priceEl.style.display = "none"; // hide if no price
            optionInput.value = "";
        }
    }

    // Only update price when user changes the selection
    optionSelect.addEventListener("change", updatePrice);
});
</script>


</script>

<!-- MODAL SCRIPTS -->
<script>
let selectedSizePrice = null;
let selectedZone = null;

// When user selects a size
document.getElementById("optionSelect")?.addEventListener("change", function() {
    selectedSizePrice = parseInt(this.options[this.selectedIndex].dataset.price);
    updateAddButton();
});


// When user selects zone in modal
function selectZone(zoneName) {
    selectedZone = zoneName;

    // Update the zone button text
    document.getElementById("zoneButton").innerHTML =
        zoneName + ' <span class="dropdown-icon">⌄</span>';

    // Write zone to hidden input
    document.getElementById("zoneInput").value = zoneName;

    closeZoneModal();
    updateAddButton();
}

function updateAddButton() {
    const btn = document.getElementById("addToCartBtn");
    const sizeSelected = !!selectedSizePrice;
    const zoneSelected = !!selectedZone;

    // Enable button only when both are selected
    if (sizeSelected && zoneSelected) {
        btn.disabled = false;
        btn.textContent = "Add To Basket – " + selectedSizePrice.toLocaleString() + " KES";
        btn.classList.add("btn-enabled");
        btn.classList.remove("btn-disabled");
    } else {
        btn.disabled = true;

        // Set appropriate message based on what's missing
        if (!sizeSelected && !zoneSelected) {
            btn.textContent = "Select Size & Shipping Zone";
        } else if (!sizeSelected) {
            btn.textContent = "Select Size";
        } else if (!zoneSelected) {
            btn.textContent = "Select Shipping Zone";
        }

        btn.classList.add("btn-disabled");
        btn.classList.remove("btn-enabled");
    }
}
</script>

<script>
function openZoneModal() {
    document.getElementById("zoneModal").style.display = "flex";
}
function closeZoneModal() {
    document.getElementById("zoneModal").style.display = "none";
}
</script>

<!-- QUANTITY SCRIPT -->
<script>
let qty = 1;

document.getElementById("plus").onclick = () => {
    qty++;
    document.getElementById("qty").textContent = qty;
    document.getElementById("qtyInput").value = qty;
};

document.getElementById("minus").onclick = () => {
    if (qty > 1) qty--;
    document.getElementById("qty").textContent = qty;
    document.getElementById("qtyInput").value = qty;
};
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    let selectedSizePrice = null;
    let selectedZone = null;

    const addBtn = document.getElementById("addToCartBtn");
    const optionSelect = document.getElementById("optionSelect");
    const optionInput = document.getElementById("optionInput");
    const qtyInput = document.getElementById("qtyInput");

    // Price display
    const priceEl = document.getElementById("productPrice");
    priceEl.style.display = "none";

    // Handle size selection
    optionSelect?.addEventListener("change", function () {
        const selected = optionSelect.options[optionSelect.selectedIndex];
        selectedSizePrice = parseInt(selected.dataset.price);
        optionInput.value = selected.value;

        if (selectedSizePrice) {
            priceEl.style.display = "inline";
            priceEl.textContent = selectedSizePrice.toLocaleString() + " KES";
        } else {
            priceEl.style.display = "none";
        }
        updateAddButton();
    });

    // Handle shipping zone selection
    window.selectZone = function(zoneName) {
        selectedZone = zoneName;
        document.getElementById("zoneButton").innerHTML = zoneName + ' <span class="dropdown-icon">⌄</span>';
        document.getElementById("zoneInput").value = zoneName;
        closeZoneModal();
        updateAddButton();
    };

    // Enable button only when both size & zone are selected
    function updateAddButton() {
        if (selectedSizePrice && selectedZone) {
            addBtn.disabled = false;
            addBtn.classList.remove("btn-disabled");
            addBtn.classList.add("btn-enabled");
            addBtn.textContent = "Add to Basket – " + selectedSizePrice.toLocaleString() + " KES";
        } else {
            addBtn.disabled = true;
            addBtn.classList.remove("btn-enabled");
            addBtn.classList.add("btn-disabled");

            if (!selectedSizePrice && !selectedZone) {
                addBtn.textContent = "Select Size & Shipping Zone";
            } else if (!selectedSizePrice) {
                addBtn.textContent = "Select Size";
            } else {
                addBtn.textContent = "Select Shipping Zone";
            }
        }
    }

    // Add to cart AJAX
    addBtn.addEventListener("click", function () {
        if (this.disabled) return;

        const formData = new FormData();
        formData.append("quantity", qtyInput.value);
        formData.append("option_id", optionInput.value);
        formData.append("zone", selectedZone);

        const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
        fetch(document.getElementById("addToCartForm").action, {
            method: "POST",
            headers: { "X-CSRFToken": csrf },
            body: formData
        })
        .then(res => res.text())
        .then(html => {
            document.getElementById("cartSidebar").innerHTML = html;
            document.getElementById("cartWrapper").classList.add("cart-open");
        })
        .catch(err => console.error("Cart error:", err));
    });
});
</script>


</body>
</html>